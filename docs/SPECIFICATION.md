# Dott Specification

## Overview

Dottは、リモートリポジトリからdotfilesを取得・管理・同期するためのコマンドラインツールです。
リモートの更新チェックやリモート・ローカルでの変更の同期、シンボリックリンクの自動管理、依存関係のインストール、安全なバックアップ機能を提供します。

## 全体仕様

### アーキテクチャ

- **設定ディレクトリ**: `~/.dott/`
- **デフォルトのリポジトリクローン先**: `~/.dott/repo/`
- **ローカル設定**: `~/.dott/settings.json`
- **バックアップ**: `~/.dott/backups/{timestamp}/`

### 設定ファイル

#### dott.toml（リポジトリ内）
リポジトリのルートに配置するか、.dott/dott.tomlとして配置します。

```toml
[symlinks]
"システム内パス" = "リポジトリ内パス"

[scripts.deps]
macos = "スクリプトパス"
linux = "スクリプトパス"

[scripts.custom]
名前 = "スクリプトパス"
```

#### settings.json（ローカル）
ローカル設定ファイルは、dottの初期化時に自動生成されます。
~/.dott/settings.jsonとして配置されます。

```json
{
  "repository": {
    "url": "リポジトリURL",
    "path": "リポジトリローカルパス",
    "branch": "ブランチ名"
  },
  "backup": {
    "enabled": true,
    "path": "バックアップディレクトリ"
  },
  "sync": {
    "auto_check": false,
    "merge_strategy": "rebase"
  }
}
```

## コマンド仕様

### `dott init`

リモートリポジトリからdottを初期化します。

**機能**:
- リモートリポジトリの指定（コマンドライン引数または対話的入力）
- 設定ファイル（dott.toml）の検証
- ローカル環境の構築

**コマンド形式**:
```bash
# オプション引数でURL指定
dott init --repo <repository_url>

# 対話的入力（引数なし）
dott init
```

**処理内容**:
1. リポジトリURL取得（`--repo`指定または対話的入力）
2. リポジトリURLの妥当性確認
3. リモートリポジトリから`dott.toml`を取得・検証
4. `~/.dott/`ディレクトリ作成
5. リポジトリを`~/.dott/repo/`にクローン
6. `~/.dott/settings.json`を作成

**対話的入力例**:
```
$ dott init
? Repository URL: https://github.com/username/dotfiles.git
🔍 Validating repository...
✅ Repository validation successful
📁 Creating ~/.dott/ directory...
🔄 Cloning repository...
✅ Initialization complete!
```

**オプション**:
- `--repo <url>`: リモートリポジトリのURL

**エラーケース**:
- 無効なURL
- アクセス不可能なリポジトリ
- `dott.toml`の不存在・不正

### `dott install deps`

システム依存関係をインストールします。

**機能**:
- プラットフォーム検出（macOS / Linux）
- 設定ファイルで指定されたスクリプトの実行

**対応プラットフォーム**:
- **macOS**: `[scripts.deps]`の`macos`で指定されたスクリプトを実行
- **Linux**: `[scripts.deps]`の`linux`で指定されたスクリプトを実行

**処理内容**:
1. 現在のプラットフォームを検出
2. プラットフォームに対応する設定を`[scripts.deps]`から取得
3. 指定されたスクリプトファイルの存在確認
4. スクリプトを実行

**設定例**:
```toml
[scripts.deps]
macos = "scripts/install-deps-macos.sh"
linux = "scripts/install-deps-linux.sh"
```

**エラーケース**:
- 未対応プラットフォーム（Windows等）
- 対応するプラットフォーム設定の不存在
- スクリプトファイルの不存在
- スクリプト実行権限の不足
- スクリプト実行エラー

### `dott install config`

設定ファイルのシンボリックリンクを作成します。

**機能**:
- シンボリックリンクの作成
- 既存ファイルとの競合処理
- バックアップ機能

**処理内容**:
1. `[symlinks]`設定の読み込み
2. プラットフォーム固有設定の適用
3. 各ファイルの競合チェック
4. 競合時のユーザー選択（バックアップ/中断）
5. シンボリックリンクの作成

**エラーケース**:
- ソースファイルの不存在
- ターゲットディレクトリの作成失敗
- 権限エラー

### `dott install <custom>`

カスタムインストールスクリプトを実行します。

**機能**:
- 指定されたカスタムスクリプトの実行
- 実行順序の制御

**処理内容**:
1. `[scripts.custom]`から指定スクリプトを検索
2. スクリプトファイルの存在確認
3. 実行権限の確認
4. スクリプト実行

**エラーケース**:
- 存在しないスクリプト名
- スクリプトファイルの不存在
- 実行権限の不足
- スクリプト実行エラー

### `dott status`

現在の状態を表示します。

**機能**:
- リポジトリ同期状態の表示
- シンボリックリンク状態の表示
- 依存関係状態の表示

**表示内容**:
- リポジトリ情報（URL、ブランチ、同期状態）
- シンボリックリンク統計（総数、アクティブ、競合）
- 依存関係統計（インストール済み、未インストール）
- 利用可能なカスタムスクリプト数

**オプション**:
- `--quiet`: 簡潔な表示

### `dott symlinks`

シンボリックリンクの詳細状態を一覧表示します。

**機能**:
- 各シンボリンクの状態表示
- 競合やエラーの詳細表示

**表示内容**:
- ✅ 正常なシンボリンク
- ❌ 競合（既存ファイル）
- ⚠️ エラー（ソース不存在など）
- 🔄 バックアップ済み

### `dott symlinks restore`

バックアップからファイルを復元します。

**機能**:
- バックアップファイルの復元
- 復元対象の選択

**オプション**:
- `--list`: 利用可能なバックアップ一覧
- `--all`: 全ファイルの一括復元
- `<filepath>`: 特定ファイルの復元

### `dott sync`

リモートリポジトリと同期します。

**機能**:
- リモートからの変更取得
- ローカルリポジトリの更新
- 必要に応じたシンボリンクの再作成

**処理内容**:
1. リモートリポジトリの変更確認
2. ローカル変更の確認
3. マージ戦略に基づく同期
4. 設定変更時のシンボリンク更新

**オプション**:
- `--force`: ローカル変更を無視して強制同期

### `dott config`

設定の表示・編集を行います。

**機能**:
- 設定情報の表示
- ローカル設定の編集

**オプション**:
- `--repo`: リポジトリ設定（dott.toml）を表示
- `--edit`: ローカル設定（settings.json）を編集

## テストケース

### 初期化テスト

**正常な初期化（オプション指定）**
- 前提: 有効なリモートリポジトリURL
- 実行: `dott init --repo https://github.com/user/dotfiles.git`
- 期待: `~/.dott/`構築、リポジトリクローン、設定ファイル作成

**正常な初期化（対話的入力）**
- 前提: 有効なリモートリポジトリURL
- 実行: `dott init` → URL入力プロンプト
- 期待: 対話的にURL入力、`~/.dott/`構築、リポジトリクローン、設定ファイル作成

**無効なリポジトリ**
- 前提: 存在しないリポジトリURL
- 実行: `dott init --repo https://github.com/invalid/repo.git`
- 期待: エラーメッセージ、ローカルファイル未作成

**対話的入力でのキャンセル**
- 前提: 対話的入力でユーザーがキャンセル
- 実行: `dott init` → Ctrl+C または空入力
- 期待: 処理中断、ローカルファイル未作成

**設定ファイル不備**
- 前提: `dott.toml`が存在しないリポジトリ
- 実行: `dott init <repository_without_config>`
- 期待: 設定ファイル不備エラー、初期化中断

### 依存関係インストールテスト

**正常な依存関係インストール（macOS）**
- 前提: 初期化済み、macOS環境、有効なスクリプト設定
- 実行: `dott install deps`
- 期待: `[scripts.deps]`の`macos`スクリプト実行

**正常な依存関係インストール（Linux）**
- 前提: 初期化済み、Linux環境、有効なスクリプト設定
- 実行: `dott install deps`
- 期待: `[scripts.deps]`の`linux`スクリプト実行

**未対応プラットフォーム**
- 前提: Windows環境
- 実行: `dott install deps`
- 期待: 未対応プラットフォームエラー

**依存関係スクリプト設定不在**
- 前提: プラットフォーム対応設定が`[scripts.deps]`に存在しない
- 実行: `dott install deps`
- 期待: 設定不在エラー

### 設定インストールテスト

**正常なシンボリンク作成**
- 前提: 競合のない環境
- 実行: `dott install config`
- 期待: 設定通りのシンボリンク作成

**ファイル競合の処理**
- 前提: 既存ファイルが存在
- 実行: `dott install config`
- 期待: 競合選択肢の提示、バックアップまたは中断

**シンボリンク状態の表示**
- 前提: 一部シンボリンクが作成済み
- 実行: `dott symlinks`
- 期待: 各シンボリンクの状態表示

### カスタムインストールテスト

**正常なカスタムスクリプト実行**
- 前提: 有効なカスタムスクリプト設定
- 実行: `dott install vim-plugins`
- 期待: 指定スクリプト実行

**存在しないカスタムスクリプト**
- 前提: 設定にないスクリプト名
- 実行: `dott install non-existent-script`
- 期待: エラーメッセージ

### ステータス表示テスト

**正常なステータス表示**
- 前提: 初期化済み環境
- 実行: `dott status`
- 期待: リポジトリ情報、シンボリンク状況、依存関係状況の表示

**未初期化環境**
- 前提: dottが初期化されていない
- 実行: `dott status`
- 期待: 未初期化メッセージ

### 同期テスト

**正常な同期**
- 前提: リモートに新しいコミットが存在
- 実行: `dott sync`
- 期待: ローカルリポジトリ更新、必要に応じたシンボリンク再作成

**競合のある同期**
- 前提: ローカルに未コミットの変更
- 実行: `dott sync`
- 期待: 競合警告、`--force`オプション案内

### バックアップ・復元テスト

**バックアップからの復元**
- 前提: バックアップが存在
- 実行: `dott symlinks restore ~/.zshrc`
- 期待: 指定ファイルのバックアップからの復元

**バックアップ一覧表示**
- 前提: 複数のバックアップが存在
- 実行: `dott symlinks restore --list`
- 期待: 利用可能なバックアップの一覧表示
